<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three Men's Morris</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3WSV6HLD3S"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3WSV6HLD3S');
    </script>

    <style>
        /* General Body Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #eef2f7;
            margin: 0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Main Game Container */
        .game-container {
            text-align: center;
            background-color: white;
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 5;
            width: auto;
            max-width: 500px;
        }
        
        /* Game Mode & Lobby Selection */
        .selection-screen h2 { margin-top: 0; }
        .hidden { display: none !important; }
        
        /* Online Lobby Styles */
        #online-lobby {
            padding: 20px;
        }
        #game-link-container {
            margin-top: 15px;
            display: flex;
            justify-content: center;
        }
        #game-link-input {
            width: 70%;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 5px 0 0 5px;
            font-size: 14px;
            text-align: center;
        }
        #copy-link-button {
            padding: 10px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 0 5px 5px 0;
            font-size: 14px;
        }
        #lobby-status {
            margin-top: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
        }

        /* Title */
        #title-link { text-decoration: none; color: inherit; cursor: pointer; }
        h1 { margin-bottom: 20px; }
        
        /* Score Settings */
        .settings-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 500;
        }
        #winning-score-input {
            width: 60px;
            padding: 8px;
            border: 2px solid #ccc;
            border-radius: 5px;
            font-size: 18px;
            text-align: center;
            font-weight: bold;
            -moz-appearance: textfield;
            appearance: textfield;
        }
        #winning-score-input::-webkit-outer-spin-button,
        #winning-score-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .score-control {
            width: 35px;
            height: 35px;
            border: 2px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 4px; 
            user-select: none;
        }
        .score-control:disabled { cursor: not-allowed; opacity: 0.5; }
        
        /* Scoreboard */
        .scoreboard-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: bold;
        }
        .player-score { padding: 10px 20px; border-radius: 8px; }
        #black-player-score { background-color: #f0f0f0; border-left: 5px solid black; }
        #red-player-score { background-color: #f0f0f0; border-left: 5px solid #d92121; }

        /* Game Board */
        .board-container {
            position: relative;
            width: 360px;
            height: 360px;
            margin: 20px auto;
            touch-action: none;
        }
        .board-container.disabled {
            pointer-events: none;
            opacity: 0.6;
        }
        #board-lines { position: absolute; top: 0; left: 0; z-index: 1; }
        .points-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            z-index: 2;
        }
        .point { cursor: pointer; }
        
        /* Stones / Coins */
        .stone {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%); 
            z-index: 3;
            pointer-events: none;
            transition: box-shadow 0.2s ease-in-out;
        }
        .stone.selected {
            box-shadow: 0 0 15px 5px #007bff; /* Highlight for selected stone */
        }
        .black { background-color: #000000; }
        .red { background-color: #d92121; }
        
        /* Status & Buttons */
        #status { font-size: 24px; margin-top: 20px; height: 30px; font-weight: bold; color: #007bff; }
        .buttons-container { margin-top: 20px; }
        .game-button { padding: 12px 25px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; margin: 0 10px; }
        #newMatchButton { background-color: #4CAF50; }

        /* Victory Overlay */
        #victory-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }
        #victory-overlay.visible { opacity: 1; pointer-events: auto; }
        .victory-content {
            text-align: center; color: white;
            transform: scale(0.5); opacity: 0;
            transition: all 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) 0.3s;
        }
        #victory-overlay.visible .victory-content { transform: scale(1); opacity: 1; }
        .trophy { font-size: 150px; line-height: 1; }
        #victory-overlay.visible .trophy { animation: trophy-animation 1s ease-out forwards; }
        #winner-message { font-size: 3em; margin: 20px 0; text-shadow: 0 0 15px gold; }
        #countdown-message { font-size: 1.2em; margin-top: 20px; color: #f0f0f0; }

        @keyframes trophy-animation {
            0% { transform: translateY(100px) scale(0.5) rotate(-30deg); opacity: 0; }
            60% { transform: translateY(-20px) scale(1.1) rotate(10deg); opacity: 1; }
            100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; }
        }

        /* Mobile View Styles */
        @media (max-width: 600px) {
            .game-container {
                padding: 15px; width: 95vw; height: 98vh;
                display: flex; flex-direction: column; justify-content: center;
            }
            .board-container { width: 90vw; height: 90vw; max-width: 300px; max-height: 300px; }
            .stone { width: 12vw; height: 12vw; max-width: 40px; max-height: 40px; }
            h1 { font-size: 1.5em; margin-bottom: 10px; }
            #status { font-size: 1.1em; margin-top: 15px; }
            .game-button { padding: 10px 15px; font-size: 14px; }
            .scoreboard-container { font-size: 16px; margin-bottom: 15px; }
            .settings-container { font-size: 16px; margin-bottom: 15px; }
            #winner-message { font-size: 2em; }
        }
    </style>
</head>
<body>

    <div class="game-container">
        
        <div id="mode-selection" class="selection-screen">
            <h2>Select Game Mode</h2>
            <div class="buttons-container">
                <button id="twoPlayerButton" class="game-button" style="background-color: #007bff;">Two Player</button>
                <button id="botButton" class="game-button" style="background-color: #dc3545;">Play with Bot</button>
                <button id="onlineButton" class="game-button" style="background-color: #28a745;">Online Play</button>
            </div>
        </div>

        <div id="online-lobby" class="selection-screen hidden">
            <h2>Online Game</h2>
            <p>Share this link with your friend to play:</p>
            <div id="game-link-container">
                <input type="text" id="game-link-input" readonly>
                <button id="copy-link-button">Copy</button>
            </div>
            <div id="lobby-status">Waiting for opponent to join...</div>
        </div>

        <div id="game-area" class="hidden">
            <a href="#" id="title-link"><h1>Three Men's Morris</h1></a>
            <div class="settings-container">
                <label for="winning-score-input">Winning Score:</label>
                <button id="decrease-score" class="score-control">-</button>
                <input type="number" id="winning-score-input" value="10" min="1">
                <button id="increase-score" class="score-control">+</button>
            </div>
            <div class="scoreboard-container">
                <div id="black-player-score" class="player-score">Black: <span id="black-score">0</span></div>
                <div id="red-player-score" class="player-score">Red: <span id="red-score">0</span></div>
            </div>
            <div id="board-container" class="board-container">
                <canvas id="board-lines"></canvas>
                <div id="points-grid" class="points-grid"></div>
                <div id="stones-container"></div>
            </div>
            <div id="status"></div>
            <div class="buttons-container">
                <button id="newMatchButton" class="game-button">New Game</button>
            </div>
        </div>
    </div>

    <div id="victory-overlay">
        <div class="victory-content">
            <div class="trophy">üèÜ</div>
            <h2 id="winner-message"></h2>
            <p id="countdown-message"></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    
    <!-- FIREBASE INTEGRATION START -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
      import { getDatabase, ref, set, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      const firebaseConfig = {
        apiKey: "YOUR_API_KEY", // <-- IMPORTANT: PASTE YOUR CREDENTIALS HERE
        authDomain: "threemenmorrisonline.firebaseapp.com",
        databaseURL: "https://threemenmorrisonline-default-rtdb.firebaseio.com",
        projectId: "threemenmorrisonline",
        storageBucket: "threemenmorrisonline.firebasestorage.app",
        messagingSenderId: "749361110172",
        appId: "1:749361110172:web:3a1192daac2d599b3d2159",
        measurementId: "G-WVRBH1Z9L2"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const database = getDatabase(app);

      // Make database functions globally accessible to the other script
      window.firebaseDB = { database, ref, set, onValue, get, child };
    </script>
    <!-- FIREBASE INTEGRATION END -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const modeSelection = document.getElementById('mode-selection');
            const onlineLobby = document.getElementById('online-lobby');
            const gameArea = document.getElementById('game-area');
            const twoPlayerButton = document.getElementById('twoPlayerButton');
            const botButton = document.getElementById('botButton');
            const onlineButton = document.getElementById('onlineButton');
            const gameLinkInput = document.getElementById('game-link-input');
            const copyLinkButton = document.getElementById('copy-link-button');
            const lobbyStatus = document.getElementById('lobby-status');
            const titleLink = document.getElementById('title-link');
            const winningScoreInput = document.getElementById('winning-score-input');
            const decreaseScoreButton = document.getElementById('decrease-score');
            const increaseScoreButton = document.getElementById('increase-score');
            const pointsGrid = document.getElementById('points-grid');
            const stonesContainer = document.getElementById('stones-container');
            const statusElement = document.getElementById('status');
            const newMatchButton = document.getElementById('newMatchButton');
            const blackScoreElement = document.getElementById('black-score');
            const redScoreElement = document.getElementById('red-score');
            const canvas = document.getElementById('board-lines');
            const ctx = canvas.getContext('2d');
            const boardContainer = document.getElementById('board-container');
            const victoryOverlay = document.getElementById('victory-overlay');
            const winnerMessage = document.getElementById('winner-message');
            const countdownMessage = document.getElementById('countdown-message');

            // --- Game State Variables ---
            let BOARD_SIZE;
            let blackScore = 0, redScore = 0, winningScore = 10;
            let roundStarter = 1;
            let currentPlayer, boardState, stonesPlaced, isGameActive;
            let selectedStoneIndex = -1;
            let gameResetTimer = null;
            let gameMode = ''; // 'bot', 'local', 'online'
            let onlineGameId = null;
            let localPlayerNumber = null;

            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8]
            ];
            
            // --- Event Listeners ---
            twoPlayerButton.addEventListener('click', () => startGame('local', false));
            botButton.addEventListener('click', () => startGame('bot', true));
            onlineButton.addEventListener('click', createOnlineGame);
            copyLinkButton.addEventListener('click', () => {
                gameLinkInput.select();
                document.execCommand('copy');
                copyLinkButton.textContent = 'Copied!';
                setTimeout(() => { copyLinkButton.textContent = 'Copy'; }, 2000);
            });
            newMatchButton.addEventListener('click', startNewMatch);
            titleLink.addEventListener('click', (event) => { event.preventDefault(); location.href = location.pathname; });
            decreaseScoreButton.addEventListener('click', () => {
                let val = parseInt(winningScoreInput.value);
                if (val > 1) winningScoreInput.value = val - 1;
            });
            increaseScoreButton.addEventListener('click', () => {
                winningScoreInput.value = parseInt(winningScoreInput.value) + 1;
            });

            // --- ONLINE PLAY FUNCTIONS ---
            async function createOnlineGame() {
                modeSelection.classList.add('hidden');
                onlineLobby.classList.remove('hidden');

                const { database, ref, set } = window.firebaseDB;
                onlineGameId = `game-${Math.random().toString(36).substr(2, 7)}`;
                localPlayerNumber = 1; // The creator is always player 1 (Black)
                
                const gameURL = `${window.location.origin}${window.location.pathname}?game=${onlineGameId}`;
                gameLinkInput.value = gameURL;

                const initialGameState = {
                    boardState: Array(9).fill(0),
                    currentPlayer: 1,
                    stonesPlaced: 0,
                    status: 'Waiting for Player 2...',
                    blackScore: 0,
                    redScore: 0,
                    players: { p1: true, p2: false },
                    isGameActive: false,
                    winningScore: parseInt(winningScoreInput.value),
                    roundStarter: 1
                };

                await set(ref(database, 'games/' + onlineGameId), initialGameState);
                listenForOnlineUpdates();
            }

            async function joinOnlineGame(gameId) {
                const { database, ref, get, child, set } = window.firebaseDB;
                const dbRef = ref(database);
                const snapshot = await get(child(dbRef, `games/${gameId}`));

                if (snapshot.exists()) {
                    const gameState = snapshot.val();
                    if(gameState.players.p2) {
                        alert("This game is already full.");
                        return;
                    }
                    onlineGameId = gameId;
                    localPlayerNumber = 2; // The joiner is player 2 (Red)
                    
                    const updatedGameState = { ...gameState };
                    updatedGameState.players.p2 = true;
                    updatedGameState.status = "Player Black to Place";
                    updatedGameState.isGameActive = true;

                    await set(ref(database, 'games/' + onlineGameId), updatedGameState);
                    
                    startGame('online');
                    listenForOnlineUpdates();

                } else {
                    alert("Game not found!");
                    modeSelection.classList.remove('hidden');
                }
            }
            
            function listenForOnlineUpdates() {
                const { database, ref, onValue } = window.firebaseDB;
                const gameRef = ref(database, 'games/' + onlineGameId);

                onValue(gameRef, (snapshot) => {
                    const gameState = snapshot.val();
                    if (!gameState) return;

                    // If P2 joins, creator starts the game
                    if (localPlayerNumber === 1 && !gameArea.classList.contains('hidden') === false && gameState.players.p2) {
                        startGame('online');
                    }
                    
                    // Sync local state with Firebase state
                    boardState = gameState.boardState;
                    currentPlayer = gameState.currentPlayer;
                    stonesPlaced = gameState.stonesPlaced;
                    isGameActive = gameState.isGameActive;
                    blackScore = gameState.blackScore;
                    redScore = gameState.redScore;
                    winningScore = gameState.winningScore;
                    roundStarter = gameState.roundStarter;

                    // Update UI for both players
                    updateStatus(gameState.status);
                    updateScoreboard();
                    updateBoardUI();

                    // Disable board if it's not the local player's turn
                    if (isGameActive && currentPlayer !== localPlayerNumber) {
                        boardContainer.classList.add('disabled');
                    } else {
                        boardContainer.classList.remove('disabled');
                    }
                });
            }

            function updateFirebaseState() {
                if(gameMode !== 'online' || !onlineGameId) return;

                const { database, ref, set } = window.firebaseDB;
                const gameState = {
                    boardState, currentPlayer, stonesPlaced, isGameActive,
                    blackScore, redScore, status: statusElement.textContent,
                    players: {p1: true, p2: true}, winningScore, roundStarter
                };
                set(ref(database, 'games/' + onlineGameId), gameState);
            }
            
            // --- Core Game Logic ---
            function startGame(mode, isBot) {
                gameMode = mode;
                if (gameMode !== 'online') {
                    modeSelection.classList.add('hidden');
                } else {
                    onlineLobby.classList.add('hidden');
                }
                gameArea.classList.remove('hidden');
                setupInitialState();
            }

            function initializeRound() {
                currentPlayer = roundStarter; 
                boardState = Array(9).fill(0);
                stonesPlaced = 0;
                selectedStoneIndex = -1;
                isGameActive = true;
                toggleScoreControls(false);
                victoryOverlay.classList.remove('visible');
                updateStatus(getPlayerName(currentPlayer) + ' to Place');
                updateBoardUI();

                if (gameMode === 'online') updateFirebaseState();
                if (gameMode === 'bot' && currentPlayer === 1) makeBotMove();
            }
            
            function startNewMatch() {
                if(gameResetTimer) clearInterval(gameResetTimer);
                winningScore = parseInt(winningScoreInput.value) || 10;
                winningScoreInput.value = winningScore;
                blackScore = 0;
                redScore = 0;
                roundStarter = 1;
                updateScoreboard();
                initializeRound();
            }
            
            function setupInitialState() {
                updateScoreboard();
                drawBoardLines();
                createClickPoints();
                boardState = Array(9).fill(0);
                updateBoardUI();
                
                if (gameMode !== 'online') {
                    toggleScoreControls(true);
                    updateStatus('Set score & start a new game!');
                    newMatchButton.classList.remove('hidden');
                } else {
                    toggleScoreControls(false); // Only creator can set score initially
                    newMatchButton.classList.add('hidden'); // New match logic for online needs more work
                }
            }
            
            function drawBoardLines() {
                BOARD_SIZE = boardContainer.clientWidth;
                canvas.width = BOARD_SIZE;
                canvas.height = BOARD_SIZE;
                const size = BOARD_SIZE;
                if (size <= 0) return;
                const padding = size * 0.06;
                const innerSize = size - (padding * 2);
                ctx.clearRect(0, 0, size, size);
                ctx.strokeStyle = '#555';
                ctx.lineWidth = 4;
                ctx.strokeRect(padding, padding, innerSize, innerSize);
                ctx.beginPath();
                ctx.moveTo(size / 2, padding); ctx.lineTo(size / 2, size - padding);
                ctx.moveTo(padding, size / 2); ctx.lineTo(size - padding, size / 2);
                ctx.stroke();
            }

            function createClickPoints() {
                pointsGrid.innerHTML = '';
                for (let i = 0; i < 9; i++) {
                    const point = document.createElement('div');
                    point.classList.add('point');
                    point.dataset.index = i;
                    point.addEventListener('click', handlePointClick);
                    pointsGrid.appendChild(point);
                }
            }

            function handlePointClick(event) {
                if (!isGameActive) return;
                if (gameMode === 'bot' && currentPlayer === 1) return;
                if (gameMode === 'online' && currentPlayer !== localPlayerNumber) return;

                const clickedIndex = parseInt(event.currentTarget.dataset.index);

                if (stonesPlaced < 6) {
                    if (boardState[clickedIndex] === 0) {
                        placeStone(clickedIndex);
                    }
                } 
                else {
                    if (selectedStoneIndex === -1) {
                        if (boardState[clickedIndex] === currentPlayer) {
                            selectedStoneIndex = clickedIndex;
                            updateStatus('Select an empty adjacent spot');
                            updateBoardUI();
                        }
                    } 
                    else {
                        if (boardState[clickedIndex] === 0 && isAdjacent(selectedStoneIndex, clickedIndex)) {
                            boardState[clickedIndex] = currentPlayer;
                            boardState[selectedStoneIndex] = 0;
                            selectedStoneIndex = -1;
                            updateBoardUI();
                            if (checkWin(boardState, currentPlayer)) {
                                handleRoundWin();
                                return;
                            }
                            switchPlayer();
                        } 
                        else {
                            selectedStoneIndex = -1;
                            updateBoardUI();
                            updateStatus(getPlayerName(currentPlayer) + ' to Move');
                        }
                    }
                }
            }

            function placeStone(index) {
                if (boardState[index] !== 0) return;
                boardState[index] = currentPlayer;
                stonesPlaced++;
                updateBoardUI();
                if (checkWin(boardState, currentPlayer)) {
                    handleRoundWin();
                    return;
                }
                switchPlayer();
            }

            function handleRoundWin() {
                isGameActive = false;
                const winnerName = getPlayerName(currentPlayer);
                if (currentPlayer === 1) blackScore++; else redScore++;
                updateScoreboard();
                roundStarter = currentPlayer;
                
                if (gameMode === 'online') {
                    // For online, only player 1 handles the timeout and restart logic
                    if (localPlayerNumber === 1) {
                       updateStatus(`${winnerName} wins the round!`);
                       updateFirebaseState();
                       setTimeout(() => initializeRound(), 2500);
                    }
                } else {
                    if (blackScore >= winningScore || redScore >= winningScore) {
                        showVictoryCelebration(winnerName);
                    } else {
                        updateStatus(`${winnerName} wins the round!`);
                        setTimeout(initializeRound, 2000);
                    }
                }
            }

            function showVictoryCelebration(winnerName) {
                winnerMessage.textContent = `${winnerName.toUpperCase()} IS THE WINNER!`;
                victoryOverlay.classList.add('visible');
                toggleScoreControls(true);
                const duration = 3 * 1000, end = Date.now() + duration;
                (function frame() {
                    if (Date.now() > end) return;
                    confetti({ particleCount: 2, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#000000', '#d92121', '#ffffff'] });
                    confetti({ particleCount: 2, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#000000', '#d92121', '#ffffff'] });
                    requestAnimationFrame(frame);
                }());
                let countdown = 5;
                countdownMessage.textContent = `New game in ${countdown}...`;
                gameResetTimer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        countdownMessage.textContent = `New game in ${countdown}...`;
                    } else {
                        clearInterval(gameResetTimer);
                        startNewMatch();
                    }
                }, 1000);
            }
            
            function switchPlayer() {
                currentPlayer = (currentPlayer === 1) ? 2 : 1;
                const action = (stonesPlaced < 6) ? 'Place' : 'Move';
                updateStatus(getPlayerName(currentPlayer) + ` to ${action}`);
                
                if (gameMode === 'online') {
                    updateFirebaseState();
                } else if (gameMode === 'bot' && currentPlayer === 1 && isGameActive) {
                    makeBotMove();
                }
            }

            // --- UI & Helper Functions ---
            function getPlayerName(player) {
                if (gameMode === 'bot' && player === 1) return 'Bot';
                return player === 1 ? 'Black' : 'Red';
            }
            function checkWin(board, player) {
                return winPatterns.some(p => p.every(index => board[index] === player));
            }
            function isAdjacent(from, to) {
                const fromRow = Math.floor(from / 3), fromCol = from % 3;
                const toRow = Math.floor(to / 3), toCol = to % 3;
                return (fromRow === toRow && Math.abs(fromCol - toCol) === 1) ||
                       (fromCol === toCol && Math.abs(fromRow - toRow) === 1);
            }
            function updateBoardUI() {
                stonesContainer.innerHTML = '';
                boardState.forEach((player, index) => {
                    if (player !== 0) {
                        const stone = document.createElement('div');
                        stone.classList.add('stone', player === 1 ? 'black' : 'red');
                        if (index === selectedStoneIndex) {
                            stone.classList.add('selected');
                        }
                        const row = Math.floor(index / 3), col = index % 3;
                        const padding = BOARD_SIZE * 0.06;
                        const step = (BOARD_SIZE - 2 * padding) / 2;
                        stone.style.left = `${padding + col * step}px`;
                        stone.style.top = `${padding + row * step}px`;
                        stonesContainer.appendChild(stone);
                    }
                });
            }
            function toggleScoreControls(enabled) {
                winningScoreInput.disabled = !enabled;
                decreaseScoreButton.disabled = !enabled;
                increaseScoreButton.disabled = !enabled;
            }
            function updateScoreboard() {
                blackScoreElement.textContent = blackScore;
                redScoreElement.textContent = redScore;
            }
            function updateStatus(message) { statusElement.textContent = message; }
            
            // --- BOT LOGIC (Unchanged) ---
            function makeBotMove() {
                setTimeout(() => {
                    let bestMove;
                    if (stonesPlaced < 6) {
                        bestMove = findBestPlacement();
                        if (bestMove.index !== undefined) placeStone(bestMove.index);
                    } else {
                        bestMove = findBestMove();
                        if (bestMove.from !== undefined) {
                            boardState[bestMove.to] = currentPlayer;
                            boardState[bestMove.from] = 0;
                            updateBoardUI();
                            if (checkWin(boardState, currentPlayer)) { handleRoundWin(); return; }
                            switchPlayer();
                        }
                    }
                }, 500);
            }
            function evaluate(board) {
                if (checkWin(board, 1)) return 100;
                if (checkWin(board, 2)) return -100;
                return 0;
            }
            function minimax(board, depth, isMaximizing, currentStonesPlaced) {
                let score = evaluate(board);
                if (score === 100) return score - depth;
                if (score === -100) return score + depth;
                if (depth >= 3) return score;

                if (isMaximizing) {
                    let best = -Infinity;
                    if (currentStonesPlaced < 6) {
                        for (let i = 0; i < 9; i++) {
                            if (board[i] === 0) {
                                board[i] = 1;
                                best = Math.max(best, minimax(board, depth + 1, !isMaximizing, currentStonesPlaced + 1));
                                board[i] = 0;
                            }
                        }
                    } else {
                        const botStones = board.map((v, i) => (v === 1 ? i : null)).filter(v => v !== null);
                        for (const from of botStones) {
                            for (let to = 0; to < 9; to++) {
                                if (board[to] === 0 && isAdjacent(from, to)) {
                                    board[from] = 0; board[to] = 1;
                                    best = Math.max(best, minimax(board, depth + 1, !isMaximizing, currentStonesPlaced));
                                    board[from] = 1; board[to] = 0;
                                }
                            }
                        }
                    }
                    return best;
                } else {
                    let best = Infinity;
                    if (currentStonesPlaced < 6) {
                        for (let i = 0; i < 9; i++) {
                            if (board[i] === 0) {
                                board[i] = 2;
                                best = Math.min(best, minimax(board, depth + 1, !isMaximizing, currentStonesPlaced + 1));
                                board[i] = 0;
                            }
                        }
                    } else {
                        const playerStones = board.map((v, i) => (v === 2 ? i : null)).filter(v => v !== null);
                        for (const from of playerStones) {
                            for (let to = 0; to < 9; to++) {
                                if (board[to] === 0 && isAdjacent(from, to)) {
                                    board[from] = 0; board[to] = 2;
                                    best = Math.min(best, minimax(board, depth + 1, !isMaximizing, currentStonesPlaced));
                                    board[from] = 2; board[to] = 0;
                                }
                            }
                        }
                    }
                    return best;
                }
            }
            function findBestPlacement() {
                let bestVal = -Infinity;
                let bestMove = { index: -1 };
                const emptySpots = boardState.map((v, i) => (v === 0 ? i : null)).filter(v => v !== null);
                if (boardState[4] === 0) return { index: 4 };
                for (const spot of emptySpots) {
                    const newBoard = [...boardState]; newBoard[spot] = 1;
                    const moveVal = minimax(newBoard, 0, false, stonesPlaced + 1);
                    if (moveVal > bestVal) {
                        bestMove.index = spot;
                        bestVal = moveVal;
                    }
                }
                return bestMove;
            }
            function findBestMove() {
                let bestVal = -Infinity;
                let bestMove = {};
                const botStones = boardState.map((v, i) => (v === 1 ? i : null)).filter(v => v !== null);
                for (const from of botStones) {
                    for (let to = 0; to < 9; to++) {
                        if (boardState[to] === 0 && isAdjacent(from, to)) {
                            const newBoard = [...boardState]; newBoard[from] = 0; newBoard[to] = 1;
                            const moveVal = minimax(newBoard, 0, false, stonesPlaced);
                            if (moveVal > bestVal) {
                                bestVal = moveVal;
                                bestMove = { from, to };
                            }
                        }
                    }
                }
                return bestMove;
            }

            // --- Initial Page Load Logic ---
            const urlParams = new URLSearchParams(window.location.search);
            const gameIdFromUrl = urlParams.get('game');
            
            if (gameIdFromUrl) {
                modeSelection.classList.add('hidden');
                joinOnlineGame(gameIdFromUrl);
            } else {
                modeSelection.classList.remove('hidden');
                window.addEventListener('resize', () => {
                    drawBoardLines();
                    updateBoardUI();
                });
            }
        });
    </script>

</body>
</html>
